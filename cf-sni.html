<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare Snippets API 调用工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Cloudflare Snippets API 调用工具</h1>
        
        <!-- 基础信息 -->
        <div class="card mb-5">
            <div class="card-header">
                <h2 class="mb-0">基础信息</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="apiToken" class="form-label">API Token</label>
                        <input type="password" class="form-control" id="apiToken" required placeholder="请输入 Cloudflare API Token">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="zoneId" class="form-label">Zone ID</label>
                        <input type="text" class="form-control" id="zoneId" required placeholder="请输入 Cloudflare Zone ID">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Snippet 操作 -->
        <div class="card mb-5">
            <div class="card-header">
                <h2 class="mb-0">Snippet 操作</h2>
            </div>
            <div class="card-body">
                <!-- 创建/更新 Snippet -->
                <div class="mb-5">
                    <h3 class="mb-3">1. 创建/更新 Snippet</h3>
                    <form id="snippetForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="snippetName" class="form-label">Snippet 名称</label>
                                <input type="text" class="form-control" id="snippetName" required placeholder="请输入 Snippet 名称（只能包含 a-z、0-9 和 _）">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="snippetFile" class="form-label">JavaScript 文件</label>
                                <input type="file" class="form-control" id="snippetFile" accept=".js" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">创建/更新 Snippet</button>
                    </form>
                </div>
                
                <!-- List all code snippets -->
                <div class="mb-5">
                    <h3 class="mb-3">2. List all code snippets</h3>
                    <button id="listSnippetsBtn" class="btn btn-secondary">获取所有 Snippets</button>
                </div>
                
                <!-- Get code snippet details -->
                <div class="mb-5">
                    <h3 class="mb-3">3. Get code snippet details</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="getDetailsName" class="form-label">Snippet 名称</label>
                            <input type="text" class="form-control" id="getDetailsName" required placeholder="请输入 Snippet 名称">
                        </div>
                    </div>
                    <button id="getDetailsBtn" class="btn btn-secondary">获取 Snippet 详情</button>
                </div>
                
                <!-- Get code snippet content -->
                <div class="mb-5">
                    <h3 class="mb-3">4. Get code snippet content</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="getContentName" class="form-label">Snippet 名称</label>
                            <input type="text" class="form-control" id="getContentName" required placeholder="请输入 Snippet 名称">
                        </div>
                    </div>
                    <button id="getContentBtn" class="btn btn-secondary">获取 Snippet 内容</button>
                </div>
                
                <!-- Delete code snippet -->
                <div class="mb-5">
                    <h3 class="mb-3">5. Delete code snippet</h3>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="deleteSnippetName" class="form-label">Snippet 名称</label>
                            <input type="text" class="form-control" id="deleteSnippetName" required placeholder="请输入要删除的 Snippet 名称">
                        </div>
                    </div>
                    <button id="deleteSnippetBtn" class="btn btn-danger">删除 Snippet</button>
                </div>
            </div>
        </div>
        
        <!-- Snippet Rules 操作 -->
        <div class="card mb-5">
            <div class="card-header">
                <h2 class="mb-0">Snippet Rules 操作</h2>
            </div>
            <div class="card-body">
                <!-- Create/update/delete snippet rules -->
                <div class="mb-5">
                    <h3 class="mb-3">6. Create/update/delete snippet rules</h3>
                    <form id="ruleForm">
                        <div class="mb-3">
                            <label for="ruleDescription" class="form-label">规则描述</label>
                            <input type="text" class="form-control" id="ruleDescription" required placeholder="请输入规则描述">
                        </div>
                        
                        <div class="mb-3">
                            <label for="ruleExpression" class="form-label">规则表达式</label>
                            <input type="text" class="form-control" id="ruleExpression" required placeholder="例如：http.cookie eq \"a=b\"">
                        </div>
                        
                        <div class="mb-3">
                            <label for="ruleSnippetName" class="form-label">关联的 Snippet 名称</label>
                            <input type="text" class="form-control" id="ruleSnippetName" required placeholder="请输入要关联的 Snippet 名称">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">创建/更新 Snippet Rule</button>
                    </form>
                </div>
                
                <!-- List snippet rules -->
                <div class="mb-5">
                    <h3 class="mb-3">7. List snippet rules</h3>
                    <button id="listRulesBtn" class="btn btn-secondary">获取所有 Snippet Rules</button>
                </div>
                
                <!-- Delete all snippet rules -->
                <div class="mb-5">
                    <h3 class="mb-3">8. Delete all snippet rules</h3>
                    <button id="deleteAllRulesBtn" class="btn btn-danger">删除所有 Snippet Rules</button>
                </div>
            </div>
        </div>
        
        <!-- API 响应 -->
        <div class="card mb-5">
            <div class="card-header">
                <h2 class="mb-0">API 响应</h2>
            </div>
            <div class="card-body">
                <pre id="response" class="bg-light p-3 border rounded"></pre>
            </div>
        </div>
    </div>
    
    <script>
        // 获取基本参数
        function getBaseParams() {
            const apiToken = document.getElementById('apiToken').value;
            const zoneId = document.getElementById('zoneId').value;
            
            if (!apiToken || !zoneId) {
                alert('请先填写 API Token 和 Zone ID');
                return null;
            }
            
            return { apiToken, zoneId };
        }
        
        // 处理 Snippet 创建/更新表单提交
        document.getElementById('snippetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const baseParams = getBaseParams();
            if (!baseParams) return;
            
            const { apiToken, zoneId } = baseParams;
            const snippetName = document.getElementById('snippetName').value;
            const snippetFile = document.getElementById('snippetFile').files[0];
            
            if (!snippetFile) {
                alert('请选择一个 JavaScript 文件');
                return;
            }
            
            // 验证 Snippet 名称格式
            const nameRegex = /^[a-z0-9_]+$/;
            if (!nameRegex.test(snippetName)) {
                alert('Snippet 名称只能包含 a-z、0-9 和 _');
                return;
            }
            
            const responseElement = document.getElementById('response');
            responseElement.textContent = '正在调用 API...';
            
            try {
                // 创建 FormData
                const formData = new FormData();
                formData.append('files', snippetFile);
                formData.append('metadata', JSON.stringify({ 
                    main_module: snippetFile.name 
                }));
                
                // 发送 API 请求
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/snippets/${snippetName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = `错误：${error.message}`;
            }
        });
        
        // List all code snippets
        document.getElementById('listSnippetsBtn').addEventListener('click', async () => {
            const baseParams = getBaseParams();
            if (!baseParams) return;
            
            const { apiToken, zoneId } = baseParams;
            const responseElement = document.getElementById('response');
            responseElement.textContent = '正在调用 API...';
            
            try {
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/snippets`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                    }
                });
                
                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = `错误：${error.message}`;
            }
        });
        
        // Get code snippet details
        document.getElementById('getDetailsBtn').addEventListener('click', async () => {
            const baseParams = getBaseParams();
            if (!baseParams) return;
            
            const { apiToken, zoneId } = baseParams;
            const snippetName = document.getElementById('getDetailsName').value;
            
            if (!snippetName) {
                alert('请输入 Snippet 名称');
                return;
            }
            
            const responseElement = document.getElementById('response');
            responseElement.textContent = '正在调用 API...';
            
            try {
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/snippets/${snippetName}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                    }
                });
                
                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = `错误：${error.message}`;
            }
        });
        
        // Get code snippet content
        document.getElementById('getContentBtn').addEventListener('click', async () => {
            const baseParams = getBaseParams();
            if (!baseParams) return;
            
            const { apiToken, zoneId } = baseParams;
            const snippetName = document.getElementById('getContentName').value;
            
            if (!snippetName) {
                alert('请输入 Snippet 名称');
                return;
            }
            
            const responseElement = document.getElementById('response');
            responseElement.textContent = '正在调用 API...';
            
            try {
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/snippets/${snippetName}/content`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                    }
                });
                
                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = `错误：${error.message}`;
            }
        });
        
        // Delete code snippet
        document.getElementById('deleteSnippetBtn').addEventListener('click', async () => {
            const baseParams = getBaseParams();
            if (!baseParams) return;
            
            const { apiToken, zoneId } = baseParams;
            const snippetName = document.getElementById('deleteSnippetName').value;
            
            if (!snippetName) {
                alert('请输入要删除的 Snippet 名称');
                return;
            }
            
            if (!confirm(`确定要删除 Snippet "${snippetName}" 吗？`)) {
                return;
            }
            
            const responseElement = document.getElementById('response');
            responseElement.textContent = '正在调用 API...';
            
            try {
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/snippets/${snippetName}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                    }
                });
                
                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = `错误：${error.message}`;
            }
        });
        
        // 处理 Snippet Rule 创建/更新表单提交
        document.getElementById('ruleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const baseParams = getBaseParams();
            if (!baseParams) return;
            
            const { apiToken, zoneId } = baseParams;
            const description = document.getElementById('ruleDescription').value;
            const expression = document.getElementById('ruleExpression').value;
            const snippetName = document.getElementById('ruleSnippetName').value;
            
            const responseElement = document.getElementById('response');
            responseElement.textContent = '正在调用 API...';
            
            try {
                // 发送 API 请求
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/snippets/snippet_rules`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        rules: [{
                            description: description,
                            enabled: true,
                            expression: expression,
                            snippet_name: snippetName
                        }]
                    })
                });
                
                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = `错误：${error.message}`;
            }
        });
        
        // List snippet rules
        document.getElementById('listRulesBtn').addEventListener('click', async () => {
            const baseParams = getBaseParams();
            if (!baseParams) return;
            
            const { apiToken, zoneId } = baseParams;
            const responseElement = document.getElementById('response');
            responseElement.textContent = '正在调用 API...';
            
            try {
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/snippets/snippet_rules`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                    }
                });
                
                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = `错误：${error.message}`;
            }
        });
        
        // Delete all snippet rules
        document.getElementById('deleteAllRulesBtn').addEventListener('click', async () => {
            const baseParams = getBaseParams();
            if (!baseParams) return;
            
            const { apiToken, zoneId } = baseParams;
            
            if (!confirm('确定要删除所有 Snippet Rules 吗？')) {
                return;
            }
            
            const responseElement = document.getElementById('response');
            responseElement.textContent = '正在调用 API...';
            
            try {
                const response = await fetch(`https://api.cloudflare.com/client/v4/zones/${zoneId}/snippets/snippet_rules`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`
                    }
                });
                
                const result = await response.json();
                responseElement.textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                responseElement.textContent = `错误：${error.message}`;
            }
        });
    </script>
</body>
</html>